# #
#   @parent         github workflow
#   @desc           test build
#   @author         Aetherinox
#   @url            https://github.com/Aetherinox
# #

run-name: "üåë NPM ‚Ä∫ Tests"
name: "‚òÅÔ∏è NPM ‚Ä∫ Tests"

# #
#   triggers
# #

on:
    [pull_request, push]

# #
#   environment variables
# #

env:
    GITHUB_TOKEN: ${{ secrets.TOKEN }}
    OWNER: ${{ github.repository_owner }}

# #
#   jobs
# #

jobs:
    validate:
        runs-on: ubuntu-latest
        permissions: write-all
        steps:

            # #
            #   [ CI ] Start
            # #

            - name: "‚úÖ Start"
              id: task_dailyreset_start
              run: |
                  echo "Starting nightly reset"

            # #
            #   [ CI ] Checkout
            # #

            - name: "‚òëÔ∏è Checkout"
              id: task_dailyreset_checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # #
            #   [ CI ] Node Setup
            # #

            - name: "‚öôÔ∏è Setup ‚Ä∫ Node"
              id: task_ci_node_setup
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  registry-url: https://npm.pkg.github.com/
                  scope: '@aetherinox'

            # #
            #   [ Daily Reset ] Node - Install
            # #

            - name: "üì¶ NPM ‚Ä∫ Install"
              id: task_cloudflare_npm_install
              run: |
                  npm install
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.SELF_TOKEN_CL }}

            - name: Install dependencies
              run: npm ci

            - name: Prettier
              run: npm run pretty:fix

            - name: Lint
              run: npm run lint

            - name: Test
              run: npm run test

            - name: Create GitHub deployment
              uses: chrnorm/deployment-action@v2
              id: deployment
              with:
                  token: ${{ env.GITHUB_TOKEN }}
                  environment: test
                  initial-status: success

            - name: Delete GitHub deployment
              uses: ./
              with:
                  token: ${{ env.GITHUB_TOKEN }}
                  environment: test
